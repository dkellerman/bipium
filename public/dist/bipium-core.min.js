(function(O){"use strict";var B={exports:{}},z;function Z(){return z||(z=1,(function(y){var e=(function(s){var a=Object.prototype,o=a.hasOwnProperty,u=Object.defineProperty||function(i,t,r){i[t]=r.value},c,d=typeof Symbol=="function"?Symbol:{},b=d.iterator||"@@iterator",k=d.asyncIterator||"@@asyncIterator",T=d.toStringTag||"@@toStringTag";function f(i,t,r){return Object.defineProperty(i,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),i[t]}try{f({},"")}catch{f=function(t,r,h){return t[r]=h}}function S(i,t,r,h){var n=t&&t.prototype instanceof q?t:q,l=Object.create(n.prototype),p=new F(h||[]);return u(l,"_invoke",{value:nt(i,r,p)}),l}s.wrap=S;function A(i,t,r){try{return{type:"normal",arg:i.call(t,r)}}catch(h){return{type:"throw",arg:h}}}var N="suspendedStart",_="suspendedYield",J="executing",G="completed",w={};function q(){}function M(){}function D(){}var P={};f(P,b,function(){return this});var R=Object.getPrototypeOf,j=R&&R(R(W([])));j&&j!==a&&o.call(j,b)&&(P=j);var E=D.prototype=q.prototype=Object.create(P);M.prototype=D,u(E,"constructor",{value:D,configurable:!0}),u(D,"constructor",{value:M,configurable:!0}),M.displayName=f(D,T,"GeneratorFunction");function K(i){["next","throw","return"].forEach(function(t){f(i,t,function(r){return this._invoke(t,r)})})}s.isGeneratorFunction=function(i){var t=typeof i=="function"&&i.constructor;return t?t===M||(t.displayName||t.name)==="GeneratorFunction":!1},s.mark=function(i){return Object.setPrototypeOf?Object.setPrototypeOf(i,D):(i.__proto__=D,f(i,T,"GeneratorFunction")),i.prototype=Object.create(E),i},s.awrap=function(i){return{__await:i}};function x(i,t){function r(l,p,v,g){var m=A(i[l],i,p);if(m.type==="throw")g(m.arg);else{var Y=m.arg,I=Y.value;return I&&typeof I=="object"&&o.call(I,"__await")?t.resolve(I.__await).then(function(L){r("next",L,v,g)},function(L){r("throw",L,v,g)}):t.resolve(I).then(function(L){Y.value=L,v(Y)},function(L){return r("throw",L,v,g)})}}var h;function n(l,p){function v(){return new t(function(g,m){r(l,p,g,m)})}return h=h?h.then(v,v):v()}u(this,"_invoke",{value:n})}K(x.prototype),f(x.prototype,k,function(){return this}),s.AsyncIterator=x,s.async=function(i,t,r,h,n){n===void 0&&(n=Promise);var l=new x(S(i,t,r,h),n);return s.isGeneratorFunction(t)?l:l.next().then(function(p){return p.done?p.value:l.next()})};function nt(i,t,r){var h=N;return function(l,p){if(h===J)throw new Error("Generator is already running");if(h===G){if(l==="throw")throw p;return at()}for(r.method=l,r.arg=p;;){var v=r.delegate;if(v){var g=X(v,r);if(g){if(g===w)continue;return g}}if(r.method==="next")r.sent=r._sent=r.arg;else if(r.method==="throw"){if(h===N)throw h=G,r.arg;r.dispatchException(r.arg)}else r.method==="return"&&r.abrupt("return",r.arg);h=J;var m=A(i,t,r);if(m.type==="normal"){if(h=r.done?G:_,m.arg===w)continue;return{value:m.arg,done:r.done}}else m.type==="throw"&&(h=G,r.method="throw",r.arg=m.arg)}}}function X(i,t){var r=t.method,h=i.iterator[r];if(h===c)return t.delegate=null,r==="throw"&&i.iterator.return&&(t.method="return",t.arg=c,X(i,t),t.method==="throw")||r!=="return"&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),w;var n=A(h,i.iterator,t.arg);if(n.type==="throw")return t.method="throw",t.arg=n.arg,t.delegate=null,w;var l=n.arg;if(!l)return t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,w;if(l.done)t[i.resultName]=l.value,t.next=i.nextLoc,t.method!=="return"&&(t.method="next",t.arg=c);else return l;return t.delegate=null,w}K(E),f(E,T,"Generator"),f(E,b,function(){return this}),f(E,"toString",function(){return"[object Generator]"});function ot(i){var t={tryLoc:i[0]};1 in i&&(t.catchLoc=i[1]),2 in i&&(t.finallyLoc=i[2],t.afterLoc=i[3]),this.tryEntries.push(t)}function U(i){var t=i.completion||{};t.type="normal",delete t.arg,i.completion=t}function F(i){this.tryEntries=[{tryLoc:"root"}],i.forEach(ot,this),this.reset(!0)}s.keys=function(i){var t=Object(i),r=[];for(var h in t)r.push(h);return r.reverse(),function n(){for(;r.length;){var l=r.pop();if(l in t)return n.value=l,n.done=!1,n}return n.done=!0,n}};function W(i){if(i!=null){var t=i[b];if(t)return t.call(i);if(typeof i.next=="function")return i;if(!isNaN(i.length)){var r=-1,h=function n(){for(;++r<i.length;)if(o.call(i,r))return n.value=i[r],n.done=!1,n;return n.value=c,n.done=!0,n};return h.next=h}}throw new TypeError(typeof i+" is not iterable")}s.values=W;function at(){return{value:c,done:!0}}return F.prototype={constructor:F,reset:function(i){if(this.prev=0,this.next=0,this.sent=this._sent=c,this.done=!1,this.delegate=null,this.method="next",this.arg=c,this.tryEntries.forEach(U),!i)for(var t in this)t.charAt(0)==="t"&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=c)},stop:function(){this.done=!0;var i=this.tryEntries[0],t=i.completion;if(t.type==="throw")throw t.arg;return this.rval},dispatchException:function(i){if(this.done)throw i;var t=this;function r(g,m){return l.type="throw",l.arg=i,t.next=g,m&&(t.method="next",t.arg=c),!!m}for(var h=this.tryEntries.length-1;h>=0;--h){var n=this.tryEntries[h],l=n.completion;if(n.tryLoc==="root")return r("end");if(n.tryLoc<=this.prev){var p=o.call(n,"catchLoc"),v=o.call(n,"finallyLoc");if(p&&v){if(this.prev<n.catchLoc)return r(n.catchLoc,!0);if(this.prev<n.finallyLoc)return r(n.finallyLoc)}else if(p){if(this.prev<n.catchLoc)return r(n.catchLoc,!0)}else if(v){if(this.prev<n.finallyLoc)return r(n.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(i,t){for(var r=this.tryEntries.length-1;r>=0;--r){var h=this.tryEntries[r];if(h.tryLoc<=this.prev&&o.call(h,"finallyLoc")&&this.prev<h.finallyLoc){var n=h;break}}n&&(i==="break"||i==="continue")&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var l=n?n.completion:{};return l.type=i,l.arg=t,n?(this.method="next",this.next=n.finallyLoc,w):this.complete(l)},complete:function(i,t){if(i.type==="throw")throw i.arg;return i.type==="break"||i.type==="continue"?this.next=i.arg:i.type==="return"?(this.rval=this.arg=i.arg,this.method="return",this.next="end"):i.type==="normal"&&t&&(this.next=t),w},finish:function(i){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===i)return this.complete(r.completion,r.afterLoc),U(r),w}},catch:function(i){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===i){var h=r.completion;if(h.type==="throw"){var n=h.arg;U(r)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(i,t,r){return this.delegate={iterator:W(i),resultName:t,nextLoc:r},this.method==="next"&&(this.arg=c),w}},s})(y.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(B)),B.exports}Z();const $={bpm:80,beats:4,subDivs:1,swing:0,workerUrl:void 0,lookaheadInterval:.025,scheduleAheadTime:.1,startDelayTime:.2};class Q{constructor(e){this.started=!1,this.startTime=0,this.barStart=0,this.lastBar=0,this.scheduledClicks=[],this.opts={...$,...e},this.started=!1,this.next={bar:0,beat:0,beats:this.opts.beats,subDiv:0,subDivs:this.opts.subDivs,time:0},this.opts.workerUrl?this.worker=new Worker(this.opts.workerUrl):this.worker=new tt,this.worker.onmessage=s=>{s.data==="tick"&&(this.scheduler(),this.opts.onSchedulerTick?.())},this.worker.postMessage({interval:this.opts.lookaheadInterval})}start(){this.started||(this.startTime=this.now+this.opts.startDelayTime,this.stopTime=void 0,this.barStart=this.startTime,this.lastBar=0,this.started=!0,this.scheduledClicks=[],this.opts.subDivs%2>0&&(this.opts.swing=0),this.next={bar:1,beat:1,beats:this.opts.beats,subDiv:1,subDivs:this.opts.subDivs,time:this.startTime},this.worker.postMessage("start"),this.opts.onStart?.(),this.opts.clicker?.audioContext?.state==="suspended"&&this.opts.clicker.audioContext.resume())}stop(){this.started&&(this.stopTime=this.now,this.started=!1,this.worker.postMessage("stop"),this.unscheduleClicks(),this.opts.onStop?.())}update({bpm:e,beats:s,subDivs:a,swing:o}){if(this.unscheduleClicks(),e!==void 0&&(this.opts.bpm=e),s!==void 0&&(this.opts.beats=s),a!==void 0&&(this.opts.subDivs=a),o!==void 0&&(this.opts.swing=o),(e!==void 0||s!==void 0)&&this.started&&this.scheduledClicks.length){for(this.lastClick&&(this.next={...this.lastClick});this.next.time<=this.now-this.subDivTime;)this.next.time+=this.subDivTime;this.advance()}this.opts.onUpdateOptions?.(this.opts)}scheduler(){if(!this.started)return;const e=this.lastClick;for(e&&(e.bar||0)>this.lastBar&&(this.lastBar=e.bar,this.barStart=e.time);this.next.time<this.now+this.opts.scheduleAheadTime;)this.scheduleClick(),this.advance()}scheduleClick(){const e={...this.next,beats:this.opts.beats,subDivs:this.opts.subDivs},s=this.opts.clicker?.scheduleClickSound(e);this.opts.onNextClick?.(e),this.scheduledClicks.push({...e,obj:s});const a=this.now;this.scheduledClicks=this.scheduledClicks.filter(o=>o?.time>=a-10)}advance(){let e=this.beatTime/this.opts.subDivs;this.next.subDiv%2===1?e+=e*(this.opts.swing/100):e*=(100-this.opts.swing)/100,this.next.time+=e,this.next.subDiv%this.opts.subDivs===0?(this.next.subDiv=1,this.next.beat++,this.next.beat>this.opts.beats&&(this.next.beat=1,this.next.bar++)):this.next.subDiv++}unscheduleClicks(){this.scheduledClicks=(this.scheduledClicks||[]).map(e=>e.time>this.now?(this.opts.clicker?.removeClickSound(e),this.opts.onUnscheduleClick?.(e),null):e).filter(Boolean)}get now(){return this.opts.timerFn()}get beatTime(){return 60/this.opts.bpm}get subDivTime(){return this.beatTime/this.opts.subDivs}get barTime(){return this.opts.beats*this.beatTime}get totalSubDivs(){return this.opts.beats*this.opts.subDivs}get gridTimes(){const e=this.barTime/this.totalSubDivs*(this.opts.swing/100)||0;return Array.from(Array(this.totalSubDivs).keys()).map(s=>{const a=s*(this.barTime/this.totalSubDivs);return s%2===1?a+e:a})}get elapsed(){return this.now-this.startTime}get lastClick(){const e=this.scheduledClicks?.filter(s=>s.time<=this.now);return e?.[e.length-1]||null}getClickIndex(e,s){return e?(e.bar-1)*this.opts.beats+(e.beat-1)*(s??this.opts.subDivs)+(e.subDiv-1):-1}getClickBarIndex(e,s){return(e.beat-1)*(s??this.opts.subDivs)+(e.subDiv-1)}quantize(e,s){const a=s??this.opts.subDivs,o=e-this.barStart,u=this.gridTimes.concat([this.barTime]).filter((k,T)=>T%(this.opts.subDivs/a)===0),c=u.reduce((k,T)=>Math.abs(T-o)<Math.abs(k-o)?T:k),d=c-o;let b=u.indexOf(c);return b===this.opts.beats*a&&(b=0),b++,[d,b]}}class tt{onmessage(e){}postMessage(e){typeof e=="object"&&e.interval?(this.interval=e.interval,this.clearTimer()):e==="start"?(this.startTimer(),this.tick()):e==="stop"&&this.clearTimer()}startTimer(){this.interval&&(this.timer=setInterval(this.tick.bind(this),this.interval*1e3))}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}tick(){this.onmessage({data:"tick"})}}const V={name:"Defaults",bar:880,beat:440,subDiv:220,user:660};class H{constructor({audioContext:e,volume:s=100,sounds:a=V}){this.sounds={},this.audioContext=e,this.volume=s,this.loading=!1,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.setSounds(a)}async setSounds(e){this.sounds=await this.fetchSounds(e)}async fetchSounds(e){this.loading=!0;for(const s in e){if(s==="name")continue;let a;if(Array.isArray(e[s])?a=e[s][0]:(a=e[s],e[s]=[a,1,.05]),typeof a=="string"){const o=await et(this.audioContext,a);e[s][0]=o}}return this.loading=!1,e}setVolume(e){this.volume=e}scheduleClickSound({time:e,subDiv:s,beat:a,beats:o}){if(this.loading)return;let u;const c=this.sounds;a===1&&s===1?u=c.bar||c.beat:a===Math.ceil(o/2)+1&&s===1?u=c.half||c.beat:a>1&&s===1?u=c.beat:u=c.subDiv||c.beat;const[d,b,k]=u;return this.playSoundAt(d,e,k,b)}removeClickSound(e){e?.obj?.stop(0)}playSoundAt(e,s,a,o=1){this.audioContext?.state==="suspended"&&this.audioContext.resume();let u;if(typeof e=="number")u=this.audioContext.createOscillator(),u.connect(this.gainNode),u.frequency.value=e,u.start(s),u.stop(s+a);else{u=this.audioContext.createBufferSource();try{u.buffer=e}catch(c){console.error(c)}u.connect(this.gainNode),u.start(s,0,a)}return this.gainNode.gain.setValueAtTime(this.volume*o/100,s),u}click(e=0){const[s,a,o]=this.sounds.user;return this.playSoundAt(s,e,o,a)}}async function et(y,e){const a=await(await fetch(e)).arrayBuffer();return await y.decodeAudioData(a)}const it={qThreshold:.04};class C{constructor(e){this.progress=0,this.lastTime=0,this.savedClick=null,this.count=[],this.qType=null,this.userClicks=[],this.opts={...it,...e}}start(){this.progress=0,this.lastTime=0,this.savedClick=this.opts.metronome.lastClick,this.count=[],this.qType=null,this.userClicks=[]}stop(){this.progress=0,this.count=[],this.userClicks=[],this.savedClick=null,this.qType=null}update(){const{savedClick:e,lastTime:s,userClicks:a}=this,o=this.opts.metronome,u=o.elapsed-s;if(C.frameRate.push(u),C.frameRate.length>100&&C.frameRate.shift(),!o.started||o.elapsed<0)return;const c=o.getClickIndex(e),d=o.lastClick,b=o.getClickIndex(d,e?.subDivs);if(d&&b>c){this.savedClick=d;const f=o.getClickBarIndex(d);this.progress=1/o.totalSubDivs*f,f%2===1&&(this.progress+=1/o.totalSubDivs*(o.opts.swing/100))}else{const f=this.progress,S=1-f,A=o.barTime*S,N=S/A,_=u*N;this.progress=(f+_)%1}this.lastTime=o.elapsed;let k=d?.beat||1,T=d?.subDiv||1;if(this.count=o.opts.subDivs>1?[k,T]:[k],a?.length){const f=a.pop();for(;a.length;)a.pop();const[S]=o.quantize(f,1);this.qType=rt(S,this.opts.qThreshold)}}static get frameRateInfo(){const e=C.frameRate;if(!e?.length)return 0;const s=e.reduce((o,u)=>o+u)/e.length,a=Math.sqrt(e.map(o=>Math.pow(o-s,2)).reduce((o,u)=>o+u)/e.length);return{mean:s,std:a}}}C.frameRate=[];function rt(y,e){return y<=-1*e?"late":y>=e?"early":"ontime"}function st(y,e={},s=new AudioContext){const a=new H({audioContext:s,...e});return new Q({timerFn:()=>s.currentTime,clicker:a,...y})}O.Clicker=H,O.DEFAULT_SOUNDS=V,O.Metronome=Q,O.Visualizer=C,O.createMetronome=st,Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})})(this.Bipium=this.Bipium||{});
