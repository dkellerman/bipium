(function(O){"use strict";var _={exports:{}},z;function Z(){return z||(z=1,(function(w){var e=(function(r){var h=Object.prototype,o=h.hasOwnProperty,u,f=typeof Symbol=="function"?Symbol:{},d=f.iterator||"@@iterator",k=f.asyncIterator||"@@asyncIterator",b=f.toStringTag||"@@toStringTag";function c(i,t,s){return Object.defineProperty(i,t,{value:s,enumerable:!0,configurable:!0,writable:!0}),i[t]}try{c({},"")}catch{c=function(t,s,a){return t[s]=a}}function T(i,t,s,a){var n=t&&t.prototype instanceof q?t:q,l=Object.create(n.prototype),p=new F(a||[]);return l._invoke=nt(i,s,p),l}r.wrap=T;function C(i,t,s){try{return{type:"normal",arg:i.call(t,s)}}catch(a){return{type:"throw",arg:a}}}var I="suspendedStart",j="suspendedYield",G="executing",M="completed",y={};function q(){}function N(){}function D(){}var R={};c(R,d,function(){return this});var P=Object.getPrototypeOf,x=P&&P(P(W([])));x&&x!==h&&o.call(x,d)&&(R=x);var A=D.prototype=q.prototype=Object.create(R);N.prototype=D,c(A,"constructor",D),c(D,"constructor",N),N.displayName=c(D,b,"GeneratorFunction");function J(i){["next","throw","return"].forEach(function(t){c(i,t,function(s){return this._invoke(t,s)})})}r.isGeneratorFunction=function(i){var t=typeof i=="function"&&i.constructor;return t?t===N||(t.displayName||t.name)==="GeneratorFunction":!1},r.mark=function(i){return Object.setPrototypeOf?Object.setPrototypeOf(i,D):(i.__proto__=D,c(i,b,"GeneratorFunction")),i.prototype=Object.create(A),i},r.awrap=function(i){return{__await:i}};function B(i,t){function s(l,p,v,g){var m=C(i[l],i,p);if(m.type==="throw")g(m.arg);else{var Y=m.arg,E=Y.value;return E&&typeof E=="object"&&o.call(E,"__await")?t.resolve(E.__await).then(function(L){s("next",L,v,g)},function(L){s("throw",L,v,g)}):t.resolve(E).then(function(L){Y.value=L,v(Y)},function(L){return s("throw",L,v,g)})}}var a;function n(l,p){function v(){return new t(function(g,m){s(l,p,g,m)})}return a=a?a.then(v,v):v()}this._invoke=n}J(B.prototype),c(B.prototype,k,function(){return this}),r.AsyncIterator=B,r.async=function(i,t,s,a,n){n===void 0&&(n=Promise);var l=new B(T(i,t,s,a),n);return r.isGeneratorFunction(t)?l:l.next().then(function(p){return p.done?p.value:l.next()})};function nt(i,t,s){var a=I;return function(l,p){if(a===G)throw new Error("Generator is already running");if(a===M){if(l==="throw")throw p;return X()}for(s.method=l,s.arg=p;;){var v=s.delegate;if(v){var g=K(v,s);if(g){if(g===y)continue;return g}}if(s.method==="next")s.sent=s._sent=s.arg;else if(s.method==="throw"){if(a===I)throw a=M,s.arg;s.dispatchException(s.arg)}else s.method==="return"&&s.abrupt("return",s.arg);a=G;var m=C(i,t,s);if(m.type==="normal"){if(a=s.done?M:j,m.arg===y)continue;return{value:m.arg,done:s.done}}else m.type==="throw"&&(a=M,s.method="throw",s.arg=m.arg)}}}function K(i,t){var s=i.iterator[t.method];if(s===u){if(t.delegate=null,t.method==="throw"){if(i.iterator.return&&(t.method="return",t.arg=u,K(i,t),t.method==="throw"))return y;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return y}var a=C(s,i.iterator,t.arg);if(a.type==="throw")return t.method="throw",t.arg=a.arg,t.delegate=null,y;var n=a.arg;if(!n)return t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,y;if(n.done)t[i.resultName]=n.value,t.next=i.nextLoc,t.method!=="return"&&(t.method="next",t.arg=u);else return n;return t.delegate=null,y}J(A),c(A,b,"Generator"),c(A,d,function(){return this}),c(A,"toString",function(){return"[object Generator]"});function ot(i){var t={tryLoc:i[0]};1 in i&&(t.catchLoc=i[1]),2 in i&&(t.finallyLoc=i[2],t.afterLoc=i[3]),this.tryEntries.push(t)}function U(i){var t=i.completion||{};t.type="normal",delete t.arg,i.completion=t}function F(i){this.tryEntries=[{tryLoc:"root"}],i.forEach(ot,this),this.reset(!0)}r.keys=function(i){var t=[];for(var s in i)t.push(s);return t.reverse(),function a(){for(;t.length;){var n=t.pop();if(n in i)return a.value=n,a.done=!1,a}return a.done=!0,a}};function W(i){if(i){var t=i[d];if(t)return t.call(i);if(typeof i.next=="function")return i;if(!isNaN(i.length)){var s=-1,a=function n(){for(;++s<i.length;)if(o.call(i,s))return n.value=i[s],n.done=!1,n;return n.value=u,n.done=!0,n};return a.next=a}}return{next:X}}r.values=W;function X(){return{value:u,done:!0}}return F.prototype={constructor:F,reset:function(i){if(this.prev=0,this.next=0,this.sent=this._sent=u,this.done=!1,this.delegate=null,this.method="next",this.arg=u,this.tryEntries.forEach(U),!i)for(var t in this)t.charAt(0)==="t"&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=u)},stop:function(){this.done=!0;var i=this.tryEntries[0],t=i.completion;if(t.type==="throw")throw t.arg;return this.rval},dispatchException:function(i){if(this.done)throw i;var t=this;function s(g,m){return l.type="throw",l.arg=i,t.next=g,m&&(t.method="next",t.arg=u),!!m}for(var a=this.tryEntries.length-1;a>=0;--a){var n=this.tryEntries[a],l=n.completion;if(n.tryLoc==="root")return s("end");if(n.tryLoc<=this.prev){var p=o.call(n,"catchLoc"),v=o.call(n,"finallyLoc");if(p&&v){if(this.prev<n.catchLoc)return s(n.catchLoc,!0);if(this.prev<n.finallyLoc)return s(n.finallyLoc)}else if(p){if(this.prev<n.catchLoc)return s(n.catchLoc,!0)}else if(v){if(this.prev<n.finallyLoc)return s(n.finallyLoc)}else throw new Error("try statement without catch or finally")}}},abrupt:function(i,t){for(var s=this.tryEntries.length-1;s>=0;--s){var a=this.tryEntries[s];if(a.tryLoc<=this.prev&&o.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var n=a;break}}n&&(i==="break"||i==="continue")&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var l=n?n.completion:{};return l.type=i,l.arg=t,n?(this.method="next",this.next=n.finallyLoc,y):this.complete(l)},complete:function(i,t){if(i.type==="throw")throw i.arg;return i.type==="break"||i.type==="continue"?this.next=i.arg:i.type==="return"?(this.rval=this.arg=i.arg,this.method="return",this.next="end"):i.type==="normal"&&t&&(this.next=t),y},finish:function(i){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.finallyLoc===i)return this.complete(s.completion,s.afterLoc),U(s),y}},catch:function(i){for(var t=this.tryEntries.length-1;t>=0;--t){var s=this.tryEntries[t];if(s.tryLoc===i){var a=s.completion;if(a.type==="throw"){var n=a.arg;U(s)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(i,t,s){return this.delegate={iterator:W(i),resultName:t,nextLoc:s},this.method==="next"&&(this.arg=u),y}},r})(w.exports);try{regeneratorRuntime=e}catch{typeof globalThis=="object"?globalThis.regeneratorRuntime=e:Function("r","regeneratorRuntime = r")(e)}})(_)),_.exports}Z();const $={bpm:80,beats:4,subDivs:1,swing:0,workerUrl:void 0,lookaheadInterval:.025,scheduleAheadTime:.1,startDelayTime:.2};class Q{constructor(e){this.started=!1,this.startTime=0,this.barStart=0,this.lastBar=0,this.scheduledClicks=[],this.opts={...$,...e},this.started=!1,this.next={bar:0,beat:0,beats:this.opts.beats,subDiv:0,subDivs:this.opts.subDivs,time:0},this.opts.workerUrl?this.worker=new Worker(this.opts.workerUrl):this.worker=new tt,this.worker.onmessage=r=>{r.data==="tick"&&(this.scheduler(),this.opts.onSchedulerTick?.())},this.worker.postMessage({interval:this.opts.lookaheadInterval})}start(){this.started||(this.startTime=this.now+this.opts.startDelayTime,this.stopTime=void 0,this.barStart=this.startTime,this.lastBar=0,this.started=!0,this.scheduledClicks=[],this.opts.subDivs%2>0&&(this.opts.swing=0),this.next={bar:1,beat:1,beats:this.opts.beats,subDiv:1,subDivs:this.opts.subDivs,time:this.startTime},this.worker.postMessage("start"),this.opts.onStart?.(),this.opts.clicker?.audioContext?.state==="suspended"&&this.opts.clicker.audioContext.resume())}stop(){this.started&&(this.stopTime=this.now,this.started=!1,this.worker.postMessage("stop"),this.unscheduleClicks(),this.opts.onStop?.())}update({bpm:e,beats:r,subDivs:h,swing:o}){if(this.unscheduleClicks(),e!==void 0&&(this.opts.bpm=e),r!==void 0&&(this.opts.beats=r),h!==void 0&&(this.opts.subDivs=h),o!==void 0&&(this.opts.swing=o),(e!==void 0||r!==void 0)&&this.started&&this.scheduledClicks.length){for(this.lastClick&&(this.next={...this.lastClick});this.next.time<=this.now-this.subDivTime;)this.next.time+=this.subDivTime;this.advance()}this.opts.onUpdateOptions?.(this.opts)}scheduler(){if(!this.started)return;const e=this.lastClick;for(e&&(e.bar||0)>this.lastBar&&(this.lastBar=e.bar,this.barStart=e.time);this.next.time<this.now+this.opts.scheduleAheadTime;)this.scheduleClick(),this.advance()}scheduleClick(){const e={...this.next,beats:this.opts.beats,subDivs:this.opts.subDivs},r=this.opts.clicker?.scheduleClickSound(e);this.opts.onNextClick?.(e),this.scheduledClicks.push({...e,obj:r});const h=this.now;this.scheduledClicks=this.scheduledClicks.filter(o=>o?.time>=h-10)}advance(){let e=this.beatTime/this.opts.subDivs;this.next.subDiv%2===1?e+=e*(this.opts.swing/100):e*=(100-this.opts.swing)/100,this.next.time+=e,this.next.subDiv%this.opts.subDivs===0?(this.next.subDiv=1,this.next.beat++,this.next.beat>this.opts.beats&&(this.next.beat=1,this.next.bar++)):this.next.subDiv++}unscheduleClicks(){this.scheduledClicks=(this.scheduledClicks||[]).map(e=>e.time>this.now?(this.opts.clicker?.removeClickSound(e),this.opts.onUnscheduleClick?.(e),null):e).filter(Boolean)}get now(){return this.opts.timerFn()}get beatTime(){return 60/this.opts.bpm}get subDivTime(){return this.beatTime/this.opts.subDivs}get barTime(){return this.opts.beats*this.beatTime}get totalSubDivs(){return this.opts.beats*this.opts.subDivs}get gridTimes(){const e=this.barTime/this.totalSubDivs*(this.opts.swing/100)||0;return Array.from(Array(this.totalSubDivs).keys()).map(r=>{const h=r*(this.barTime/this.totalSubDivs);return r%2===1?h+e:h})}get elapsed(){return this.now-this.startTime}get lastClick(){const e=this.scheduledClicks?.filter(r=>r.time<=this.now);return e?.[e.length-1]||null}getClickIndex(e,r){return e?(e.bar-1)*this.opts.beats+(e.beat-1)*(r??this.opts.subDivs)+(e.subDiv-1):-1}getClickBarIndex(e,r){return(e.beat-1)*(r??this.opts.subDivs)+(e.subDiv-1)}quantize(e,r){const h=r??this.opts.subDivs,o=e-this.barStart,u=this.gridTimes.concat([this.barTime]).filter((b,c)=>c%(this.opts.subDivs/h)===0),f=u.reduce((b,c)=>Math.abs(c-o)<Math.abs(b-o)?c:b),d=f-o;let k=u.indexOf(f);return k===this.opts.beats*h&&(k=0),k++,[d,k]}}class tt{onmessage(e){}postMessage(e){typeof e=="object"&&e.interval?(this.interval=e.interval,this.clearTimer()):e==="start"?(this.startTimer(),this.tick()):e==="stop"&&this.clearTimer()}startTimer(){this.interval&&(this.timer=setInterval(this.tick.bind(this),this.interval*1e3))}clearTimer(){this.timer&&(clearInterval(this.timer),this.timer=null)}tick(){this.onmessage({data:"tick"})}}const V={name:"Defaults",bar:880,beat:440,subDiv:220,user:660};class H{constructor({audioContext:e,volume:r=100,sounds:h=V}){this.sounds={},this.audioContext=e,this.volume=r,this.loading=!1,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.setSounds(h)}async setSounds(e){this.sounds=await this.fetchSounds(e)}async fetchSounds(e){this.loading=!0;for(const r in e){if(r==="name")continue;let h;if(Array.isArray(e[r])?h=e[r][0]:(h=e[r],e[r]=[h,1,.05]),typeof h=="string"){const o=await et(this.audioContext,h);e[r][0]=o}}return this.loading=!1,e}setVolume(e){this.volume=e}scheduleClickSound({time:e,subDiv:r,beat:h,beats:o}){if(this.loading)return;let u;const f=this.sounds;h===1&&r===1?u=f.bar||f.beat:h===Math.ceil(o/2)+1&&r===1?u=f.half||f.beat:h>1&&r===1?u=f.beat:u=f.subDiv||f.beat;const[d,k,b]=u;return this.playSoundAt(d,e,b,k)}removeClickSound(e){e?.obj?.stop(0)}playSoundAt(e,r,h,o=1){this.audioContext?.state==="suspended"&&this.audioContext.resume();let u;if(typeof e=="number")u=this.audioContext.createOscillator(),u.connect(this.gainNode),u.frequency.value=e,u.start(r),u.stop(r+h);else{u=this.audioContext.createBufferSource();try{u.buffer=e}catch(f){console.error(f)}u.connect(this.gainNode),u.start(r,0,h)}return this.gainNode.gain.setValueAtTime(this.volume*o/100,r),u}click(e=0){const[r,h,o]=this.sounds.user;return this.playSoundAt(r,e,o,h)}}async function et(w,e){const h=await(await fetch(e)).arrayBuffer();return await w.decodeAudioData(h)}const it={qThreshold:.04};class S{constructor(e){this.progress=0,this.lastTime=0,this.savedClick=null,this.count=[],this.qType=null,this.userClicks=[],this.opts={...it,...e}}start(){this.progress=0,this.lastTime=0,this.savedClick=this.opts.metronome.lastClick,this.count=[],this.qType=null,this.userClicks=[]}stop(){this.progress=0,this.count=[],this.userClicks=[],this.savedClick=null,this.qType=null}update(){const{savedClick:e,lastTime:r,userClicks:h}=this,o=this.opts.metronome,u=o.elapsed-r;if(S.frameRate.push(u),S.frameRate.length>100&&S.frameRate.shift(),!o.started||o.elapsed<0)return;const f=o.getClickIndex(e),d=o.lastClick,k=o.getClickIndex(d,e?.subDivs);if(d&&k>f){this.savedClick=d;const T=o.getClickBarIndex(d);this.progress=1/o.totalSubDivs*T,T%2===1&&(this.progress+=1/o.totalSubDivs*(o.opts.swing/100))}else{const T=this.progress,C=1-T,I=o.barTime*C,j=C/I,G=u*j;this.progress=(T+G)%1}this.lastTime=o.elapsed;let b=d?.beat||1,c=d?.subDiv||1;if(this.count=o.opts.subDivs>1?[b,c]:[b],h?.length){const T=h.pop();for(;h.length;)h.pop();const[C]=o.quantize(T,1);this.qType=st(C,this.opts.qThreshold)}}static get frameRateInfo(){const e=S.frameRate;if(!e?.length)return 0;const r=e.reduce((o,u)=>o+u)/e.length,h=Math.sqrt(e.map(o=>Math.pow(o-r,2)).reduce((o,u)=>o+u)/e.length);return{mean:r,std:h}}}S.frameRate=[];function st(w,e){return w<=-1*e?"late":w>=e?"early":"ontime"}function rt(w,e={},r=new AudioContext){const h=new H({audioContext:r,...e});return new Q({timerFn:()=>r.currentTime,clicker:h,...w})}O.Clicker=H,O.DEFAULT_SOUNDS=V,O.Metronome=Q,O.Visualizer=S,O.createMetronome=rt,Object.defineProperty(O,Symbol.toStringTag,{value:"Module"})})(this.Bipium=this.Bipium||{});
